---
title: "Skin Reflectance"
author: "Tina Lasisi"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  workflowr::wflow_html:
    toc: yes
    number_sections: yes
editor_options:
  chunk_output_type: console
---

```{r setup, message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
library(tidyverse)
library(knitr)
library(scales)
library(patchwork)
library(ggmulti)

# knitting to pdf
# rmarkdown::render(input = "analysis/analysis.Rmd", output_format = "pdf_document", output_dir = "output")
F = rprojroot::is_rstudio_project$make_fix_file()
palettedf <- tibble(paletteer::palettes_d_names)
# filter(.data = palettedf, length > 10 & type == "qualitative")
knitr::opts_chunk$set(echo = FALSE, include = TRUE, eval = TRUE, warning = FALSE, message = FALSE, fig.retina = 2, fig.width = 8, fig.height = 6, out.width = "100%")
```


```{r functions, include=FALSE}
# This is a function to save the figures
plot_path = F("output/")
pltsave_func <- function(plot, plot_path, width, height){
  ggsave(
      filename = paste0(deparse(substitute(plot)), ".png"),
      plot = plot, 
      path = plot_path,
      width = width,
      height = height)
  plot(plot)
}
```

```{r df-import, include=FALSE}
# Importing data

skin <- read_csv("data/forr_reflectance.csv", 
    col_types = cols(l = col_factor(levels = c("F", 
        "R", "L", "H")), fp = col_factor(levels = c("South_Asian", 
        "East_Asian", "Northern_European", 
        "Southern European", "Afr_Eur", "African"))))

head(skin)

```


```{r df-pivot}

skin_long <- pivot_longer(skin, starts_with("W"), names_to = "wavelength", values_to = "reflectance")%>% 
  mutate(wavelength = as.numeric(str_remove(wavelength, "\\D+")),
         population = fct_collapse(fp, Asian = c("South_Asian", "East_Asian"),
                                   European = c("Northern_European", "Southern European"))) %>% 
  filter(id != 143632 & id !=143334)


skin_long

```

```{r df-filter}

df_plot <- skin_long %>%
  drop_na() %>%
  filter(reflectance>2 & l == "F") %>% 
  group_by(id, population, wavelength) %>% 
  mutate(median = median(reflectance)) %>% 
  mutate(mean = mean(reflectance))
  
```

```{r}

df_plot %>% 
  ungroup() %>% 
  summarise(count = n_distinct(id))
```


```{r plt-skin}


ggplot(df_plot, aes(wavelength, median, group=id, color=cmi)) +
# ggplot(df_plot, aes(wavelength, mean, group=id, color=cmi)) + 
  geom_line() +
  facet_wrap(~population, ncol = 2) +
  # scale_color_gradient2(low = "blue", high = "red", mid = "cyan")
  # scale_color_gradient(low = "#f7eed7", high = "#42230c") +
  # scale_color_distiller(palette = 'YlOrRd') +
  scale_color_gradientn(colours = c("#fbf7ec", "#a15c33" , "#42230c"),
                        values = rescale(x= c(20, 40, 50)),
                        oob = squish,
                        limits = c(20, 100)) +
  expand_limits(y = 0) +
  theme_classic() +
  ylab("Percent Reflectance of Skin") +
  labs(color = "Melanin Index")
  

```

```{r}

# df_plot %>% 
#   group_by(population) %>% 
#   summarise(min = min(cmi), max = max(cmi))
  
df_hist <- df_plot %>%
  mutate(fitz = case_when(cmi <= 25 ~ "Type 1",
                          cmi <= 30 ~ "Type 2",
                          cmi <= 35 ~ "Type 3",
                          cmi <= 40 ~ "Type 4",
                          cmi <= 80 ~ "Type 5",
                          TRUE ~ "Type 6"),
         fitz = factor(fitz, levels = c("Type 1", "Type 2", "Type 3", "Type 4", "Type 5", "Type 6")))

ggplot(df_hist, aes(x=cmi, fill=population, color=population)) +
  geom_histogram(position="identity", alpha=0.5) +
  theme_classic()

ggplot(df_hist, aes(x=as.numeric(fitz), fill=population, color=population)) +
  geom_histogram(position="identity", alpha=0.5, bins = 6) +
  theme_classic()

# Density 

g <- ggplot(df_hist, 
            mapping = aes(x = fitz, 
                          y = cmi, 
                          fill = population)) + 
  geom_histogram_(as.mix = FALSE,
                  scale.y = "group",
                  alpha = 0.5,
                  binwidth = 3) + 
  labs(caption = "Figure 2")

g + geom_density_(as.mix = TRUE, 
                positive = FALSE, 
                alpha = 0.2,
                scale.y = "group",
                postition = "stack_") + 
  labs(caption = "Figure 3") +
  coord_flip() +
  theme_classic()


ggplot(df_hist,
              mapping = aes(x = cmi, fill = population)) + 
  # it is equivalent to call `geom_density()`
  geom_density_(alpha = 0.3) + 
  scale_fill_brewer(palette = "Set3") + 
  labs(caption = "Figure 4")

```


